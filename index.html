<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>콘텐츠 현황 관리 (Google Sheet)</title>
    
    <script>window.process = { env: { NODE_ENV: 'production' } };</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        .icon { display: inline-block; vertical-align: middle; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 스크롤바 커스텀 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;
        const RechartsObj = window.Recharts;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, LabelList } = RechartsObj || {};

        // 사용자가 제공한 Google Apps Script URL (기본값)
        const DEFAULT_SHEET_URL = "https://script.google.com/macros/s/AKfycbzjD7U46nMHIoKjD4rm5RuuNIkDUdMlRSdAR-pS_eHSoreqQ49qf079jm2GP5GlpoIGfw/exec";

        // --- 아이콘 컴포넌트 ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>,
                Plus: <path d="M5 12h14M12 5v14"/>,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></>,
                LayoutDashboard: <><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></>,
                ExternalLink: <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></>,
                X: <path d="M18 6 6 18M6 6l12 12"/>,
                AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>,
                Menu: <><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>,
                Home: <><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
                Building2: <><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></>,
                Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
                Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
                Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
                Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
                Sheet: <><path d="M3 3h18v18H3z"/><path d="M21 9H3"/><path d="M21 15H3"/><path d="M12 3v18"/></>,
                Refresh: <><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></>,
                Check: <><polyline points="20 6 9 17 4 12"/></>,
                LinkOff: <><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`icon ${className}`}>{icons[name] || null}</svg>;
        };

        const parseCSV = (text) => { const rows = []; let currentRow = []; let currentCell = ''; let inQuotes = false; if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1); for (let i = 0; i < text.length; i++) { const char = text[i]; const nextChar = text[i + 1]; if (inQuotes) { if (char === '"' && nextChar === '"') { currentCell += '"'; i++; } else if (char === '"') { inQuotes = false; } else { currentCell += char; } } else { if (char === '"') { inQuotes = true; } else if (char === ',') { currentRow.push(currentCell.trim()); currentCell = ''; } else if (char === '\n' || char === '\r') { if (char === '\r' && nextChar === '\n') i++; currentRow.push(currentCell.trim()); if (currentRow.length > 0 && currentRow.some(c => c !== '')) rows.push(currentRow); currentRow = []; currentCell = ''; } else { currentCell += char; } } } if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); if (currentRow.length > 0 && currentRow.some(c => c !== '')) rows.push(currentRow); } return rows; };

        const renumberCompanyData = (allData, companyName) => {
            const otherData = allData.filter(d => d.company !== companyName);
            const targetData = allData.filter(d => d.company === companyName);
            let counter = 1;
            const updatedTargetData = targetData.map(item => {
                if (item.removed) return { ...item, no: '' };
                else return { ...item, no: String(counter++) };
            });
            return [...otherData, ...updatedTargetData];
        };

        // --- 구글 시트 모달 ---
        const GoogleSheetModal = ({ isOpen, onClose, sheetUrl, onSync }) => {
            const [url, setUrl] = useState(sheetUrl || '');
            useEffect(() => { setUrl(sheetUrl || '') }, [sheetUrl]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md animate-fadeIn relative p-6 space-y-4">
                        <div className="flex justify-between items-center border-b pb-3">
                            <h3 className="font-bold text-lg flex items-center gap-2"><Icon name="Sheet" className="text-green-600"/> 구글 시트 연동 설정</h3>
                            <button onClick={onClose}><Icon name="X"/></button>
                        </div>
                        <div className="text-sm text-slate-600 space-y-2">
                            <p>1. 구글 시트의 <strong>[Apps Script]</strong> 코드를 저장하세요.</p>
                            <p>2. <strong>[배포] &gt; [웹 앱]</strong> 권한을 반드시 <span className="text-red-600 font-bold">'모든 사용자(Everyone)'</span>로 설정해야 합니다.</p>
                            <p>3. 생성된 웹 앱 URL을 아래에 입력하세요.</p>
                        </div>
                        <input type="text" className="w-full p-2 border rounded text-sm bg-slate-50" value={url} onChange={(e) => setUrl(e.target.value)} placeholder="https://script.google.com/..." />
                        <div className="flex justify-end gap-2 pt-2">
                            <button onClick={() => onSync(url)} className="px-4 py-2 bg-green-600 text-white rounded text-sm font-bold hover:bg-green-700 flex items-center gap-2"><Icon name="Refresh" size={16}/> 연동 및 동기화</button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditModal = ({ isOpen, onClose, item, onSave }) => {
            const [formData, setFormData] = useState(item || {});
            useEffect(() => { setFormData(item || {}); }, [item]);
            if (!isOpen || !item) return null;
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); onClose(); };
            return (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-fadeIn relative">
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icon name="Edit" size={18} className="text-indigo-600" /> 과정 정보 수정</h3>
                            <button onClick={onClose}><Icon name="X" size={24} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">번호</label><input type="text" name="no" value={formData.no || ''} readOnly className="w-full p-2 border border-slate-200 bg-slate-100 text-slate-500 rounded text-sm cursor-not-allowed"/></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">오픈일</label><input type="text" name="openDate" value={formData.openDate || ''} onChange={handleChange} placeholder="공란일 경우 비워둠" className="w-full p-2 border border-slate-300 rounded text-sm"/></div>
                            </div>
                            <div><label className="block text-xs font-bold text-slate-500 mb-1">과정명</label><input type="text" name="title" value={formData.title || ''} onChange={handleChange} className="w-full p-2 border border-slate-300 rounded text-sm font-medium"/></div>
                            <div className="grid grid-cols-3 gap-4">
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">학점</label><input type="text" name="credits" value={formData.credits || ''} onChange={handleChange} className="w-full p-2 border border-slate-300 rounded text-sm"/></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">시간</label><input type="text" name="hours" value={formData.hours || ''} onChange={handleChange} className="w-full p-2 border border-slate-300 rounded text-sm"/></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">분야</label><input type="text" name="category" value={formData.category || ''} onChange={handleChange} className="w-full p-2 border border-slate-300 rounded text-sm"/></div>
                            </div>
                            <div><label className="block text-xs font-bold text-slate-500 mb-1">특이사항</label><textarea name="remarks" value={formData.remarks || ''} onChange={handleChange} className="w-full p-2 border border-slate-300 rounded text-sm h-20 resize-none"></textarea></div>
                            <div className="bg-slate-50 p-3 rounded border border-slate-200"><div className="flex items-center gap-2"><input type="checkbox" id="removed" name="removed" checked={!!formData.removed} onChange={(e) => setFormData(prev => ({ ...prev, removed: e.target.checked ? '삭제됨' : '' }))} className="w-4 h-4 rounded text-indigo-600"/><label htmlFor="removed" className="text-sm font-bold text-slate-700 cursor-pointer">판매 중지(삭제됨) 처리</label></div><p className="text-xs text-slate-500 mt-1 ml-6">체크 시 번호에서 제외되고 '삭제됨'으로 표시됩니다.</p></div>
                        </form>
                        <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-200 rounded-lg text-sm font-bold">취소</button><button onClick={handleSubmit} className="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow-md">저장하기</button></div>
                    </div>
                </div>
            );
        };

        const MainDashboard = ({ data, companies, onCompanyClick }) => {
            const currentMonth = new Date().toISOString().slice(0, 7).replace('-', '.');
            const stats = useMemo(() => companies.map(c => ({ name: c, total: data.filter(d => d.company === c).length, new: data.filter(d => d.company === c && (d.openDate||'').includes(currentMonth)).length })), [data, companies, currentMonth]);
            const totalCourses = stats.reduce((acc, curr) => acc + curr.total, 0);
            const totalNew = stats.reduce((acc, curr) => acc + curr.new, 0);
            if (!BarChart) return <div>Chart Load Error</div>;
            return (
                <div className="space-y-6 animate-fadeIn">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between"><div><p className="text-sm font-medium text-slate-500">총 관리 업체</p><p className="text-3xl font-bold text-slate-800 mt-1">{companies.length}개</p></div><div className="p-3 bg-blue-50 text-blue-600 rounded-full"><Icon name="Building2" size={24}/></div></div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between"><div><p className="text-sm font-medium text-slate-500">전체 콘텐츠 수</p><p className="text-3xl font-bold text-slate-800 mt-1">{totalCourses}개</p></div><div className="p-3 bg-emerald-50 text-emerald-600 rounded-full"><Icon name="FileText" size={24}/></div></div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between"><div><p className="text-sm font-medium text-slate-500">이번 달 신규 ({currentMonth})</p><p className="text-3xl font-bold text-indigo-600 mt-1">{totalNew}개</p></div><div className="p-3 bg-indigo-50 text-indigo-600 rounded-full"><Icon name="Plus" size={24}/></div></div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 className="text-lg font-bold text-slate-800 mb-6">업체별 콘텐츠 보유 현황</h3><div className="h-80"><ResponsiveContainer width="100%" height="100%"><BarChart data={stats} layout="vertical" margin={{ top: 5, right: 30, left: 40, bottom: 5 }}><CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} /><XAxis type="number" hide /><YAxis dataKey="name" type="category" width={80} tick={{ fontSize: 12 }} /><Tooltip cursor={{fill: '#F8FAFC'}} contentStyle={{borderRadius: '8px', border:'none', boxShadow:'0 4px 6px -1px rgb(0 0 0 / 0.1)'}} /><Bar dataKey="total" name="총 과정 수" fill="#3B82F6" radius={[0, 4, 4, 0]} barSize={20} onClick={(data) => onCompanyClick(data.name)}>{stats.map((entry, index) => (<Cell key={`cell-${index}`} fill={['#3B82F6', '#10B981', '#6366F1', '#F59E0B', '#EC4899', '#8B5CF6', '#14B8A6'][index % 7]} />))}<LabelList dataKey="total" position="right" style={{ fontSize: '12px', fill: '#64748B', fontWeight: 'bold' }} /></Bar></BarChart></ResponsiveContainer></div></div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 className="text-lg font-bold text-slate-800 mb-6">이번 달 신규 과정 ({currentMonth})</h3><div className="h-80"><ResponsiveContainer width="100%" height="100%"><BarChart data={stats} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="name" tick={{ fontSize: 11 }} interval={0} /><YAxis allowDecimals={false} /><Tooltip cursor={{fill: '#F8FAFC'}} contentStyle={{borderRadius: '8px', border:'none', boxShadow:'0 4px 6px -1px rgb(0 0 0 / 0.1)'}} /><Bar dataKey="new" name="신규 과정" fill="#6366F1" radius={[4, 4, 0, 0]} barSize={30} onClick={(data) => onCompanyClick(data.name)}><LabelList dataKey="new" position="top" style={{ fontSize: '12px', fill: '#6366F1', fontWeight: 'bold' }} /></Bar></BarChart></ResponsiveContainer></div></div>
                    </div>
                </div>
            );
        };

        const SearchResults = ({ data, searchTerm, companies, onDeleteRow, onUpdateRow }) => {
            const [editingItem, setEditingItem] = useState(null);
            const results = useMemo(() => {
                if(!searchTerm) return {};
                const grouped = {};
                companies.forEach(c => {
                    const items = data.filter(d => d.company === c && d.title.toLowerCase().includes(searchTerm.toLowerCase()));
                    if(items.length) grouped[c] = items;
                });
                return grouped;
            }, [data, searchTerm]);
            const hasResults = Object.keys(results).length > 0;

            return (
                <div className="space-y-8 animate-fadeIn pb-10">
                    <div className="bg-white p-4 rounded-xl border shadow-sm">
                        <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="Search" className="text-indigo-600"/> "{searchTerm}" 검색 결과</h2>
                    </div>
                    {!hasResults ? <div className="text-center py-20 bg-white rounded-xl border border-dashed text-slate-500">결과가 없습니다.</div> : 
                        Object.keys(results).map(company => (
                            <div key={company} className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                <div className="p-4 bg-slate-50 border-b font-bold">{company} ({results[company].length})</div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-slate-600">
                                        <thead className="bg-slate-100 text-xs"><tr><th className="px-4 py-3">번호</th><th className="px-4 py-3">과정명</th><th className="px-4 py-3">상태</th><th className="px-4 py-3 text-center">관리</th></tr></thead>
                                        <tbody className="divide-y">{results[company].map(row => (
                                            <tr key={row.id} className="hover:bg-slate-50"><td className="px-4 py-3">{row.no}</td><td className="px-4 py-3">{row.title}</td><td className="px-4 py-3">{row.removed ? '삭제됨':'운영중'}</td>
                                            <td className="px-4 py-3 text-center flex justify-center gap-1"><button onClick={() => setEditingItem(row)} className="text-slate-400 hover:text-indigo-600 p-1"><Icon name="Edit" size={16}/></button><button onClick={() => onDeleteRow(row.id)} className="text-slate-400 hover:text-red-600 p-1"><Icon name="Trash2" size={16}/></button></td></tr>
                                        ))}</tbody></table>
                                </div>
                            </div>
                        ))
                    }
                    <EditModal key={editingItem?.id} isOpen={!!editingItem} item={editingItem} onClose={() => setEditingItem(null)} onSave={onUpdateRow} />
                </div>
            );
        };

        const CompanyDetail = ({ company, data, onDeleteRow, onUpdateRow, onFileUpload, onWebImport, onAddRow }) => {
            const [activeTab, setActiveTab] = useState('list');
            const [editingItem, setEditingItem] = useState(null);
            
            const handleDownloadData = () => {
                const companyData = data.filter(d => d.company === company);
                const headers = ['번호', '과정명', '학점', '시간', '분', '연수분야', '자격증', '신규오픈날짜', '사라진 과정', '특이사항'];
                const csvRows = companyData.map(row => {
                    const safe = (val) => { const str = String(val || ''); return str.includes(',') || str.includes('\n') ? `"${str}"` : str; };
                    return [safe(row.no), safe(row.title), safe(row.credits), safe(row.hours), safe(row.minutes), safe(row.category), safe(row.certification), safe(row.openDate), safe(row.removed), safe(row.remarks)].join(',');
                });
                const csvContent = '\uFEFF' + headers.join(',') + '\n' + csvRows.join('\n');
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
                link.download = `${company}_데이터.csv`;
                link.click();
            };

            const companyData = data.filter(d => d.company === company);
            const chartData = useMemo(() => {
                const stats = {};
                companyData.forEach(item => {
                    let d = item.openDate || '날짜 미상';
                    if (d.length >= 4) d = d.substring(0, 4) + ((d.length >= 7) ? d.substring(4, 7) : '');
                    if (!stats[d]) stats[d] = 0; stats[d]++;
                });
                return Object.keys(stats).sort().map(k => ({ name: k, count: stats[k] }));
            }, [companyData]);

            return (
                <div className="space-y-6">
                    <div className="flex flex-col md:flex-row justify-between gap-4 border-b border-slate-200 pb-4 animate-fadeIn">
                        <div><h2 className="text-2xl font-bold text-slate-800">{company} <span className="text-sm font-normal text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full">총 {companyData.length}개</span></h2></div>
                        <div className="flex bg-slate-100 p-1 rounded-lg">
                            <button onClick={() => setActiveTab('list')} className={`px-4 py-2 rounded-md text-sm font-medium ${activeTab === 'list' ? 'bg-white shadow-sm' : 'text-slate-500'}`}>목록</button>
                            <button onClick={() => setActiveTab('stats')} className={`px-4 py-2 rounded-md text-sm font-medium ${activeTab === 'stats' ? 'bg-white shadow-sm' : 'text-slate-500'}`}>통계</button>
                        </div>
                    </div>
                    {activeTab === 'stats' ? (
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm min-h-[400px] animate-fadeIn">
                            <h3 className="font-bold mb-6">월별 추이</h3>
                            <ResponsiveContainer width="100%" height={350}><BarChart data={chartData}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="name"/><YAxis/><Tooltip/><Bar dataKey="count" fill="#3B82F6" barSize={40}><LabelList dataKey="count" position="top"/></Bar></BarChart></ResponsiveContainer>
                        </div>
                    ) : (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden animate-fadeIn">
                            <div className="p-4 border-b flex flex-wrap gap-3 justify-end">
                                <button onClick={handleDownloadData} className="flex items-center gap-2 px-3 py-2 bg-white border rounded text-sm hover:bg-slate-50"><Icon name="Download"/> 엑셀 다운</button>
                                <button onClick={onWebImport} className="flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700"><Icon name="ExternalLink"/> 웹 추출</button>
                                <label className="flex items-center gap-2 px-3 py-2 bg-emerald-600 text-white rounded cursor-pointer hover:bg-emerald-700 text-sm"><Icon name="Upload"/> CSV 업로드<input type="file" className="hidden" onChange={onFileUpload}/></label>
                                <button onClick={onAddRow} className="flex items-center gap-2 px-3 py-2 bg-white border rounded text-sm hover:bg-slate-50"><Icon name="Plus"/> 직접 입력</button>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-600">
                                    <thead className="bg-slate-100 uppercase text-xs"><tr><th className="px-4 py-3">번호</th><th className="px-4 py-3">과정명</th><th className="px-4 py-3">학점</th><th className="px-4 py-3">시간</th><th className="px-4 py-3">분야</th><th className="px-4 py-3">오픈일</th><th className="px-4 py-3">상태</th><th className="px-4 py-3">특이사항</th><th className="px-4 py-3 text-center">관리</th></tr></thead>
                                    <tbody className="divide-y divide-slate-200">
                                        {companyData.map(row => (
                                            <tr key={row.id} className="hover:bg-slate-50">
                                                <td className="px-4 py-3">{row.no}</td><td className="px-4 py-3 font-medium">{row.title}</td><td className="px-4 py-3">{row.credits}</td><td className="px-4 py-3">{row.hours}</td><td className="px-4 py-3">{row.category}</td><td className="px-4 py-3">{row.openDate}</td>
                                                <td className="px-4 py-3">{row.removed ? <span className="text-red-500 text-xs font-bold">삭제됨</span> : <span className="text-emerald-600 text-xs font-bold">운영중</span>}</td>
                                                <td className="px-4 py-3 max-w-[100px] truncate" title={row.remarks}>{row.remarks}</td>
                                                <td className="px-4 py-3 text-center flex justify-center gap-1">
                                                    <button onClick={() => setEditingItem(row)} className="text-slate-400 hover:text-indigo-600 p-1"><Icon name="Edit" size={16}/></button>
                                                    <button onClick={() => onDeleteRow(row.id)} className="text-slate-400 hover:text-red-600 p-1"><Icon name="Trash2" size={16}/></button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    <EditModal key={editingItem?.id} isOpen={!!editingItem} item={editingItem} onClose={() => setEditingItem(null)} onSave={onUpdateRow} />
                </div>
            );
        };

        const App = () => {
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedCompany, setSelectedCompany] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [data, setData] = useState([]);
            const [sheetUrl, setSheetUrl] = useState(DEFAULT_SHEET_URL);
            const [showSheetModal, setShowSheetModal] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [importText, setImportText] = useState('');
            const [detectedNewCourses, setDetectedNewCourses] = useState([]);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [loading, setLoading] = useState(false);
            const [syncError, setSyncError] = useState(false); // 연동 상태 에러 플래그

            const companies = ['비바샘', '티처빌', '아이스크림', '티셀파', '한교원', '사제동행', '창비'];
            const companyUrls = {
                '비바샘': 'https://t.vivasam.com/mdvs/menu01',
                '티처빌': 'https://www.teacherville.co.kr/trainapply/allCourseList.edu',
                '아이스크림': 'https://teacher.i-scream.co.kr/course/crs/creditList.do?searchOrdinalTyCode=TY01&searchOrderField=NEW',
                '티셀파': 'http://www.tsherpa.co.kr'
            };

            useEffect(() => {
                const localData = localStorage.getItem('courseData');
                if (localData) setData(JSON.parse(localData));
                const storedUrl = localStorage.getItem('googleSheetUrl');
                const urlToUse = storedUrl || DEFAULT_SHEET_URL;
                if (urlToUse) {
                    setSheetUrl(urlToUse);
                    fetchFromSheet(urlToUse);
                }
            }, []);

            useEffect(() => { localStorage.setItem('courseData', JSON.stringify(data)); }, [data]);

            // 구글 시트 읽기 (에러 핸들링 강화 & 캐시 방지)
            const fetchFromSheet = async (url) => {
                setLoading(true);
                setSyncError(false);
                try {
                    // 1. URL에 타임스탬프 추가하여 캐시 문제 방지
                    const targetUrl = url.includes('?') ? `${url}&action=read` : `${url}?action=read`;
                    const cacheBuster = `&t=${new Date().getTime()}`;
                    
                    const res = await fetch(targetUrl + cacheBuster, { 
                        method: 'GET',
                        redirect: 'follow',
                        credentials: 'omit' // 인증 정보 제외 (공개 스크립트 접근 시 권장)
                    });
                    
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    
                    const json = await res.json();
                    if (Array.isArray(json)) {
                        const formatted = json.map(item => ({ ...item, id: item.id || Date.now() + Math.random() }));
                        setData(formatted);
                    }
                } catch (e) {
                    console.error("Sheet Load Failed:", e);
                    setSyncError(true);
                    // 사용자에게 알림은 syncError 상태를 통해 UI로 표시됨
                } finally { setLoading(false); }
            };

            // 구글 시트 쓰기
            const saveToSheet = async (url, newData) => {
                setLoading(true);
                setSyncError(false);
                try {
                    await fetch(url + '?action=sync', {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' }, // application/json 대신 text/plain 시도 (CORS 회피용)
                        body: JSON.stringify(newData)
                    });
                } catch (e) {
                    console.error("Save Failed:", e);
                    setSyncError(true);
                } finally { setLoading(false); }
            };

            const handleSheetSync = (url) => {
                setSheetUrl(url);
                localStorage.setItem('googleSheetUrl', url);
                saveToSheet(url, data);
                setShowSheetModal(false);
            };

            const updateAndSync = (newData) => {
                setData(newData);
                if (sheetUrl) saveToSheet(sheetUrl, newData);
            };

            const handleAddRow = () => {
                const newData = [...data, { id: Date.now(), company: selectedCompany, no: '', title: '새 과정', openDate: '', removed: '' }];
                const renumbered = renumberCompanyData(newData, selectedCompany);
                updateAndSync(renumbered);
            };
            const handleDelete = (id) => {
                if(confirm('삭제하시겠습니까?\n(삭제 시 번호는 자동으로 재정렬됩니다)')) {
                    const target = data.find(d => d.id === id);
                    const newData = data.filter(d => d.id !== id);
                    const renumbered = target ? renumberCompanyData(newData, target.company) : newData;
                    updateAndSync(renumbered);
                }
            };
            const handleUpdateRow = (item) => {
                const newData = data.map(d => d.id === item.id ? item : d);
                const renumbered = renumberCompanyData(newData, item.company);
                updateAndSync(renumbered);
            };
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const rows = parseCSV(evt.target.result);
                    let startParsing = false;
                    let headerMap = {};
                    const uploadedItems = [];
                    rows.forEach(cols => {
                        if (!startParsing) {
                            const cleanCols = cols.map(c => c ? c.replace(/\s/g, '') : '');
                            if (cleanCols.includes('번호') && cleanCols.includes('과정명')) {
                                startParsing = true;
                                headerMap = {
                                    no: cleanCols.indexOf('번호'),
                                    title: cleanCols.indexOf('과정명'),
                                    credits: cleanCols.indexOf('학점'),
                                    hours: cleanCols.indexOf('시간'),
                                    category: cleanCols.indexOf('연수분야'),
                                    openDate: cleanCols.indexOf('신규오픈날짜'),
                                    removed: cleanCols.indexOf('사라진과정'),
                                    remarks: cleanCols.indexOf('특이사항')
                                };
                            }
                            return;
                        }
                        const title = cols[headerMap.title];
                        if (title && title.replace(/\s/g, '') !== '과정명') {
                            uploadedItems.push({
                                company: selectedCompany,
                                no: cols[headerMap.no] || '',
                                title: title.trim(),
                                credits: cols[headerMap.credits] || '',
                                hours: cols[headerMap.hours] || '',
                                category: cols[headerMap.category] || '',
                                openDate: cols[headerMap.openDate] || '',
                                removed: cols[headerMap.removed] || '',
                                remarks: cols[headerMap.remarks] || ''
                            });
                        }
                    });
                    if (uploadedItems.length > 0) {
                        const currentCompanyData = data.filter(d => d.company === selectedCompany);
                        const otherCompanyData = data.filter(d => d.company !== selectedCompany);
                        const dataMap = new Map();
                        currentCompanyData.forEach(item => dataMap.set(item.title.replace(/\s/g, ''), item));
                        uploadedItems.forEach(newItem => {
                            const key = newItem.title.replace(/\s/g, '');
                            if (dataMap.has(key)) dataMap.set(key, { ...dataMap.get(key), ...newItem });
                            else dataMap.set(key, { ...newItem, id: Date.now() + Math.random() });
                        });
                        const merged = [...otherCompanyData, ...Array.from(dataMap.values())];
                        const renumbered = renumberCompanyData(merged, selectedCompany);
                        updateAndSync(renumbered);
                        alert(`${uploadedItems.length}건이 처리되었습니다.`);
                    }
                };
                reader.readAsText(file, 'EUC-KR');
            };

            const analyzeImportText = () => {
                if(!importText) return;
                const lines = importText.split('\n').filter(l => l.trim().length > 2);
                setDetectedNewCourses(lines.map(t => ({ title: t, checked: true })));
            };
            const handleAddDetected = () => {
                const newItems = detectedNewCourses.filter(c => c.checked).map((c, i) => ({
                    id: Date.now() + i, company: selectedCompany, title: c.title, openDate: '', removed: '', no: '', remarks: '웹 추출'
                }));
                const newData = [...data, ...newItems];
                const renumbered = renumberCompanyData(newData, selectedCompany);
                updateAndSync(renumbered);
                setShowImportModal(false); setDetectedNewCourses([]); setImportText('');
                alert("추가 완료!");
            };

            return (
                <div className="flex min-h-screen bg-slate-50 font-sans text-slate-900">
                    <aside className="hidden md:flex w-64 flex-col bg-slate-900 text-slate-300 shadow-xl z-20 sticky top-0 h-screen">
                        <div className="p-6 border-b border-slate-700 flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white"><Icon name="LayoutDashboard" /></div>
                            <h1 className="text-lg font-bold text-white">콘텐츠<br/>현황 관리</h1>
                        </div>
                        {sheetUrl && (
                            <div className={`px-6 py-2 text-xs flex items-center gap-2 ${syncError ? 'bg-red-900 text-red-200' : 'bg-green-900 text-green-300'}`}>
                                <Icon name="Sheet" size={14}/> {syncError ? '연동 오류 (설정 확인)' : '구글 시트 연동됨'}
                            </div>
                        )}
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                            <button onClick={() => {setSelectedCompany(''); setCurrentView('dashboard');}} className="w-full flex items-center gap-3 px-4 py-3 rounded hover:bg-slate-800"><Icon name="Home"/> 메인 대시보드</button>
                            <div className="pt-4 pb-2 text-xs font-bold text-slate-500 px-4">경쟁사 목록</div>
                            {companies.map(c => <button key={c} onClick={() => {setSelectedCompany(c); setCurrentView('company');}} className="w-full flex px-4 py-3 rounded hover:bg-slate-800">{c}</button>)}
                        </nav>
                        <div className="p-4 border-t border-slate-800 text-xs text-center">© 2025 vivasam</div>
                    </aside>
                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="bg-white border-b sticky top-0 z-30 shadow-sm flex justify-between items-center p-4">
                            <div className="flex items-center gap-2 font-bold text-lg"><button className="md:hidden"><Icon name="Menu"/></button> {selectedCompany || '메인 대시보드'}</div>
                            <div className="flex items-center gap-3">
                                {loading && <div className="loader"></div>}
                                {syncError && <span className="text-xs text-red-500 font-bold hidden md:inline">연동 실패</span>}
                                <div className="relative"><input type="text" className="border rounded-full pl-8 pr-3 py-1 text-sm" placeholder="검색..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /><span className="absolute left-2.5 top-1.5 text-slate-400"><Icon name="Search" size={16}/></span></div>
                                <button onClick={() => setShowSheetModal(true)} className="text-slate-500 hover:text-green-600"><Icon name="Settings" size={24}/></button>
                            </div>
                        </header>
                        <main className="p-8">
                            {searchTerm ? <SearchResults data={data} searchTerm={searchTerm} companies={companies} onDeleteRow={handleDelete} onUpdateRow={handleUpdateRow}/> : 
                             currentView === 'dashboard' ? <MainDashboard data={data} companies={companies} onCompanyClick={(c) => {setSelectedCompany(c); setCurrentView('company');}}/> : 
                             <CompanyDetail company={selectedCompany} data={data} setData={setData} onAddRow={handleAddRow} onDeleteRow={handleDelete} onUpdateRow={handleUpdateRow} onFileUpload={handleFileUpload} onWebImport={() => {
                                 // 모달 열 때 상태 초기화
                                 setImportText('');
                                 setDetectedNewCourses([]);
                                 setAnalysisResult(null);
                                 setShowImportModal(true);
                             }}/>}
                        </main>
                    </div>
                    {/* 모달들 */}
                    <GoogleSheetModal isOpen={showSheetModal} onClose={() => setShowSheetModal(false)} sheetUrl={sheetUrl} onSync={handleSheetSync} />
                    {showImportModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 space-y-4">
                                <h3 className="font-bold text-lg flex gap-2"><Icon name="ExternalLink"/> 웹사이트 신규 과정 추출 ({selectedCompany})</h3>
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div>1. 사이트 접속 <a href={companyUrls[selectedCompany]} target="_blank" className="text-blue-600 underline">이동</a></div>
                                    <div>2. 텍스트 복사 후 붙여넣기</div>
                                </div>
                                <textarea className="w-full h-32 border rounded p-2 text-sm" value={importText} onChange={e => setImportText(e.target.value)} placeholder="붙여넣기..."></textarea>
                                <div className="flex gap-2"><button onClick={analyzeImportText} className="px-4 py-2 bg-slate-800 text-white rounded text-sm">분석하기</button></div>
                                {analysisResult && (
                                    <div className="text-xs text-slate-500 bg-slate-50 p-2 rounded">
                                        총 {analysisResult.total}줄 / 신규 {analysisResult.new}건 / 중복 {analysisResult.dup}건 / 제외 {analysisResult.ignored}건
                                    </div>
                                )}
                                {detectedNewCourses.length > 0 && <div className="max-h-40 overflow-auto border p-2 text-sm">{detectedNewCourses.map((c, i) => <div key={i}><input type="checkbox" checked={c.checked} onChange={() => {const n = [...detectedNewCourses]; n[i].checked = !n[i].checked; setDetectedNewCourses(n);}}/> {c.title}</div>)}</div>}
                                <div className="flex justify-end gap-2"><button onClick={() => setShowImportModal(false)} className="px-4 py-2 border rounded text-sm">취소</button><button onClick={handleAddDetected} className="px-4 py-2 bg-indigo-600 text-white rounded text-sm">추가하기</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>